<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>AL KHULAFAU 2025 - Student Portal & Enrollment</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.min.js"></script>
  <script>pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.worker.min.js';</script>

  <style>
    /* Professional and modern color palette */
    :root{--bg1:#4a90e2; /* Softer Blue */ --bg2:#2e74c8; /* Stronger Blue */ --card:#ffffff; --accent:#2ecc71; /* Green */ --text:#333333; --border-light:#e9e9e9; --shadow:rgba(12,20,40,0.1);}
    *{box-sizing:border-box}
    body{font-family:'Segoe UI',Roboto,Arial,sans-serif; margin:0; min-height:100vh; background:linear-gradient(135deg,var(--bg1),var(--bg2)); display:flex; align-items:center; justify-content:center; padding:24px; color:var(--text);}
    .app{width:100%;max-width:1100px;background:var(--card);border-radius:18px;padding:30px;box-shadow:0 15px 50px var(--shadow);}
    .header{display:flex;align-items:center;justify-content:space-between;gap:16px;border-bottom:1px solid var(--border-light);padding-bottom:15px;margin-bottom:10px;}
    h1{margin:0;font-size:24px;color:var(--bg2);}
    .tabs{display:flex;gap:12px;margin-top:14px;border-bottom:2px solid var(--border-light);padding-bottom:5px;}
    .tab{padding:10px 18px;border-radius:12px 12px 0 0;background:transparent;cursor:pointer;font-weight:500;transition:all 0.2s;}
    .tab:hover{background:#f0f4f8;}
    .tab.active{background:var(--bg2);color:#fff;border-bottom:2px solid var(--bg2);box-shadow:0 2px 5px rgba(0,0,0,0.1); padding-bottom:12px;}
    .content{margin-top:20px}
    .row{display:flex;gap:20px;margin-bottom:15px}
    .col{flex:1}
    input[type=text],select,input[type=file],input[type=date],input[type=password]{width:100%;padding:12px;border-radius:10px;border:1px solid var(--border-light);transition:border-color 0.2s;font-size:15px;}
    input:focus, select:focus{outline:none;border-color:var(--bg1);box-shadow:0 0 0 2px rgba(74, 144, 226, 0.2);}
    label{display:block;margin-bottom:6px;font-size:14px;font-weight:600;color:var(--text);}
    .btn{display:inline-flex;align-items:center;gap:6px;padding:10px 18px;border-radius:10px;border:none;background:var(--bg2);color:#fff;cursor:pointer;font-weight:600;transition:background 0.2s, transform 0.1s;}
    .btn:hover:not(.disabled){background:#2260a9;}
    .btn:active:not(.disabled){transform:scale(0.98);}
    .btn.secondary{background:var(--accent); color:#fff;}
    .btn.secondary:hover:not(.disabled){background:#28ae63;}
    .panel{padding:20px;border-radius:12px;background:#f8faff;border:1px solid #eef2ff;margin-bottom:20px;}
    table{width:100%;border-collapse:separate;border-spacing:0;margin-top:15px;background:#fff;border-radius:10px;overflow:hidden;}
    th,td{padding:12px 15px;border-bottom:1px solid #f0f0f0;text-align:left;font-size:14px;}
    th{background:var(--bg1);color:#fff;font-weight:600;}
    tr:last-child td{border-bottom:none;}
    .small{font-size:13px;color:#6a6a6a;}
    .result-card{padding:12px;border-radius:10px;background:#fff;border:1px solid var(--bg1);font-weight:700;color:var(--bg2);text-align:center;}
    @media(max-width:850px){.row{flex-direction:column} h1{font-size:20px;}}
    .note{font-size:14px;color:#555;padding:10px 0;margin-top:10px;border-top:1px dashed var(--border-light);}
    /* Modal */
    .modal{position:fixed;inset:0;display:flex;align-items:center;justify-content:center;background:rgba(0,0,0,0.6);z-index:1000;}
    .modal-card{background:#fff;padding:30px;border-radius:16px;width:400px;max-width:90%;box-shadow:0 10px 30px rgba(0,0,0,0.2);}
    .muted{color:#888;font-size:13px;}
    .role-badge{padding:5px 10px;border-radius:10px;background:#e8f0fe;color:#2b3bfb;font-weight:600;font-size:12px;margin-left:8px;}
    .disabled{opacity:0.5;pointer-events:none;cursor:not-allowed;}
    .status-message{padding:12px;border-radius:8px;margin-top:15px;font-weight:500;}
    .status-message.success{background:#e6f7e9;color:#28a745;border:1px solid #c3e6cb;}
    .status-message.error{background:#f8d7da;color:#dc3545;border:1px solid #f5c6cb;}
    #placedLoaderStatus { margin-top: 10px; padding: 8px; border-radius: 6px; background: #fff3cd; color: #856404; border: 1px solid #ffeeba; display: none; font-size: 14px; }
  </style>
</head>
<body>
  <div class="app" role="application">
    <div class="header">
      <div>
        <h1>AL KHULAFAU 2025 ‚Äî Student Portal</h1>
        <div class="small">PWA ¬∑ Offline Enrollment ¬∑ Multi-Format Data ¬∑ Role-Based Access</div>
      </div>
      <div style="display:flex;gap:12px;align-items:center">
        <div id="currentUser" class="muted">Not signed in</div>
        <button class="btn" id="installBtn" style="display:none">üì• Install App</button>
        <button class="btn secondary" id="signBtn">üë§ Sign In</button>
      </div>
    </div>

    <div class="tabs" role="tablist">
      <div class="tab active" data-tab="search">üîç Search Placed</div>
      <div class="tab" data-tab="enroll">üìù Enrollment</div>
      <div class="tab" data-tab="manage">‚öôÔ∏è Admin Tools</div>
    </div>

    <div class="content">

      <div id="search" class="tab-content">
        <div class="panel">
          <h2 style="margin-top:0;font-size:1.2rem;">Find Candidate Placement</h2>
          <div class="row">
            <div class="col">
              <label for="placedFile">Load Placed Candidates Data (.xlsx or .pdf)</label>
              <input type="file" id="placedFile" accept=".xlsx,.pdf" />
              <div id="placedLoaderStatus" style="display:none;"></div>
            </div>
            <div class="col">
              <label for="placedQuery">Search by Index Number or Name</label>
              <input type="text" id="placedQuery" placeholder="e.g. 0801061023 or 'ABDUL'" />
            </div>
            <div style="display:flex;align-items:flex-end;gap:8px">
              <button class="btn" id="placedSearchBtn">üîé Search</button>
            </div>
          </div>

          <div id="placedResults" style="margin-top:20px"></div>
        </div>
      </div>

      <div id="enroll" class="tab-content" style="display:none">
        <div class="panel">
          <h2 style="margin-top:0;font-size:1.2rem;">Manage Enrollment Records</h2>
          <div class="row">
            <div class="col">
              <label for="enrollFile">Load/Append Enrollment Excel (optional)</label>
              <input type="file" id="enrollFile" accept=".xlsx" />
            </div>
            <div class="col">
              <label>Total Enrolled Students (Local Cache)</label>
              <div id="enrollCount" class="result-card">0</div>
            </div>
          </div>

          <hr style="margin:18px 0;border:0;border-top:1px solid #eef2ff;" />

          <div style="margin-top:10px">
            <h3 style="margin:0 0 10px 0;font-size:1.1rem;color:var(--bg2);">New Student Enrollment Form</h3>
            <div class="row">
              <div class="col">
                <label for="e_index">Index Number*</label>
                <input type="text" id="e_index" />
              </div>
              <div class="col">
                <label for="e_name">Full Name*</label>
                <input type="text" id="e_name" />
              </div>
              <div class="col">
                <label for="e_phone">Phone Number</label>
                <input type="text" id="e_phone" placeholder="Parent/Guardian Contact" />
              </div>
            </div>
            <div class="row">
              <div class="col">
                <label for="e_gender">Gender</label>
                <select id="e_gender">
                  <option>Male</option>
                  <option>Female</option>
                  <option>Other</option>
                </select>
              </div>
              <div class="col">
                <label for="e_res">Residence Type</label>
                <select id="e_res">
                  <option>Day</option>
                  <option>Boarding</option>
                </select>
              </div>
              <div class="col">
                <label for="e_prog">Program / Course</label>
                <input type="text" id="e_prog" placeholder="e.g. General Arts / Science / Business" />
              </div>
            </div>
            <div class="row">
              <div class="col">
                <label for="e_class">Class / Form</label>
                <input type="text" id="e_class" placeholder="e.g. Form 1 Green" />
              </div>
              <div class="col">
                <label for="e_date">Date Enrolled</label>
                <input type="date" id="e_date" />
              </div>
            </div>

            <div id="enrollStatus" class="status-message" style="display:none;"></div>

            <div style="margin-top:20px; display:flex; gap:12px; justify-content:flex-end;">
              <button class="btn" id="addEnrollBtn">‚ûï Add Student to Enrollment</button>
              <button class="btn secondary" id="exportEnrollBtn">‚¨áÔ∏è Export Enrollment Excel</button>
            </div>

            <h3 style="margin:25px 0 10px 0;font-size:1.1rem;">Local Enrollment Data Preview</h3>
            <div id="enrollList" style="margin-top:12px"></div>
          </div>
        </div>
      </div>

      <div id="manage" class="tab-content" style="display:none">
        <div class="panel">
          <h2 style="margin-top:0;font-size:1.2rem;">System Administration Tools</h2>
          <div class="row">
            <div class="col">
              <label>Data Management</label>
              <button class="btn secondary" id="clearEnrollBtn">‚ö†Ô∏è Clear Local Enrollment Data</button>
              <div class="small" style="margin-top:5px; color:#c0392b;">*Requires Admin Role. Action is local and irreversible.</div>
            </div>
            <div class="col">
              <label>Download Template Files</label>
              <div style="display:flex;gap:8px">
                <button class="btn" id="downloadPlacedTemplate">Excel Placed Template</button>
                <button class="btn" id="downloadEnrollTemplate">Excel Enrollment Template</button>
              </div>
            </div>
          </div>

          <div class="note">
            <strong>PWA Status & Offline:</strong> This application is designed to be installed as a PWA for offline use. To fully enable offline caching, a separate <code>sw.js</code> file must be hosted and registered. Use the button below for a starter file.
          </div>

          <div style="margin-top:8px;display:flex;gap:8px;align-items:center">
            <button class="btn" id="downloadSwBtn">‚öôÔ∏è Download service worker (sw.js)</button>
          </div>

        </div>
      </div>

    </div>
  </div>

  <div id="signinModal" class="modal" style="display:none">
    <div class="modal-card">
      <h3 style="margin-top:0">Secure Sign In</h3>
      <div style="margin-bottom:12px" class="muted">Test accounts: <strong>admin/admin</strong> (Admin), <strong>staff/staff</strong> (Staff), <strong>viewer/viewer</strong> (Viewer)</div>
      <label for="signin_user">Username</label>
      <input type="text" id="signin_user" />
      <label style="margin-top:12px" for="signin_pass">Password</label>
      <input type="password" id="signin_pass" />
      <div style="margin-top:20px;display:flex;gap:10px;justify-content:flex-end">
        <button class="btn secondary" id="signinCancel">Cancel</button>
        <button class="btn" id="signinSubmit">üîë Sign In</button>
      </div>
      <div style="margin-top:10px" class="muted">Permissions: Admin (Full Control), Staff (Add/Export), Viewer (Search Only).</div>
    </div>
  </div>

  <script>
    // --- Global State ---
    let placedData = []; // Array of objects for placed candidates
    let enrollmentData = JSON.parse(localStorage.getItem('enrollmentData') || '[]'); // Array of objects for enrolled students
    let currentUser = JSON.parse(localStorage.getItem('ak_current_user') || 'null');

    // --- Configuration ---
    const defaultUsers = [
      {username:'admin', password:'admin', role:'Admin'},
      {username:'staff', password:'staff', role:'Staff'},
      {username:'viewer', password:'viewer', role:'Viewer'}
    ];
    let users = defaultUsers; // Simplified to use only default users

    // --- Utility Functions ---

    function escapeHtml(s){ return String(s || '').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }

    function showStatus(id, message, type) {
        const el = document.getElementById(id);
        el.className = `status-message ${type}`;
        el.innerHTML = message;
        el.style.display = 'block';
        setTimeout(() => { el.style.display = 'none'; }, 5000);
    }

    // --- PDF Reading Logic (New Feature) ---

    /** Reads text content from a PDF file */
    async function readPdfFile(file) {
        document.getElementById('placedLoaderStatus').innerHTML = 'üìÑ Reading PDF file... this may take a moment.';
        document.getElementById('placedLoaderStatus').style.display = 'block';

        const data = new Uint8Array(await file.arrayBuffer());
        const pdf = await pdfjsLib.getDocument({data: data}).promise;
        let fullText = '';
        for (let i = 1; i <= pdf.numPages; i++) {
            const page = await pdf.getPage(i);
            const textContent = await page.getTextContent();
            fullText += textContent.items.map(item => item.str).join(' ') + '\n';
        }

        // Simplistic parsing: assumes data is line-by-line, space/tab separated, with Index/Name/Gender...
        // This will need customization based on the *actual* PDF structure.
        const lines = fullText.split('\n').filter(line => line.trim().length > 10);
        const headers = ['INDEX NUMBER', 'NAME', 'GENDER', 'PHONE NUMBER', 'RESIDENCE TYPE']; // Expected headers
        const rows = [];
        
        // Skip some lines to get past typical PDF header/footer clutter
        const dataLines = lines.slice(10); // Start data after first 10 lines (adjust as needed)

        for (const line of dataLines) {
            // Split by multiple spaces or tabs
            const parts = line.trim().split(/\s{2,}/);
            if(parts.length >= 3) { // Ensure at least Index, Name, and Gender are present
                 // Basic object mapping based on position
                rows.push({
                    'INDEX NUMBER': parts[0] || '',
                    'NAME': parts[1] || '',
                    'GENDER': parts[2] || '',
                    'PHONE NUMBER': parts[3] || '',
                    'RESIDENCE TYPE': parts[4] || ''
                });
            }
        }
        
        document.getElementById('placedLoaderStatus').style.display = 'none';
        return rows;
    }


    // --- UI Update & Permission Functions ---

    function updateUserUI(){
      const el = document.getElementById('currentUser');
      const signBtn = document.getElementById('signBtn');
      if(currentUser){ 
        el.innerHTML = `${escapeHtml(currentUser.username)} <span class="role-badge">${currentUser.role}</span>`; 
        signBtn.textContent='Sign Out'; 
        signBtn.classList.add('secondary');
        signBtn.classList.remove('btn');
      }
      else { 
        el.innerText = 'Not signed in'; 
        signBtn.textContent='üë§ Sign In'; 
        signBtn.classList.remove('secondary');
        signBtn.classList.add('btn');
      }
      applyPermissions();
    }

    function applyPermissions(){
      const role = currentUser ? currentUser.role : 'Viewer';
      const addBtn = document.getElementById('addEnrollBtn');
      const exportBtn = document.getElementById('exportEnrollBtn');
      const clearBtn = document.getElementById('clearEnrollBtn');
      // Admin: add, export, clear
      // Staff: add, export
      // Viewer: none of add/export/clear
      addBtn.classList.toggle('disabled', role === 'Viewer');
      exportBtn.classList.toggle('disabled', role === 'Viewer');
      clearBtn.classList.toggle('disabled', role !== 'Admin');
    }

    // --- Render Functions ---

    function renderPlacedResults(rows){
      const out = document.getElementById('placedResults');
      if(!rows || rows.length===0){ out.innerHTML = '<div class="result-card" style="color:#e74c3c; border-color:#e74c3c;">‚ùå No results found. Try a different query or load the data.</div>'; return; }
      let html = `<div class="small" style="margin-bottom:8px;">Found ${rows.length} candidates. Showing first 200.</div>`;
      html += '<table><thead><tr><th>Index Number</th><th>Name</th><th>Gender</th><th>Phone</th><th>Residence Type</th></tr></thead><tbody>';
      rows.slice(0,200).forEach(r=>{
        html += `<tr><td>${escapeHtml(r['INDEX NUMBER'])}</td><td>${escapeHtml(r['NAME'])}</td><td>${escapeHtml(r['GENDER'])}</td><td>${escapeHtml(r['PHONE NUMBER'])}</td><td>${escapeHtml(r['RESIDENCE TYPE'])}</td></tr>`;
      });
      html += '</tbody></table>';
      if(rows.length>200) html += `<div class="small" style="margin-top:10px;">... and ${rows.length - 200} more matches not displayed.</div>`;
      out.innerHTML = html;
    }

    function renderEnrollmentList(){
      document.getElementById('enrollCount').innerText = enrollmentData.length;
      const el = document.getElementById('enrollList');
      if(enrollmentData.length===0){ el.innerHTML = '<div class="result-card small" style="color:#666; border-color:#ccc;">No enrollment records stored locally.</div>'; return; }
      let html = '<table><thead><tr><th>Index</th><th>Name</th><th>Program</th><th>Residence</th><th>Date Enrolled</th></tr></thead><tbody>';
      enrollmentData.forEach(r=>{
        html += `<tr><td>${escapeHtml(r['INDEX NUMBER'])}</td><td>${escapeHtml(r['NAME'])}</td><td>${escapeHtml(r['PROGRAM'])}</td><td>${escapeHtml(r['RESIDENCE TYPE'])}</td><td>${escapeHtml(r['DATE ENROLLED'])}</td></tr>`;
      });
      html += '</tbody></table>';
      el.innerHTML = html;
    }

    // --- Event Listeners ---

    // Load Placed Candidates (Excel or PDF)
    document.getElementById('placedFile').addEventListener('change', async (e)=>{
      const f = e.target.files[0]; if(!f) return;
      document.getElementById('placedLoaderStatus').innerHTML = '‚è≥ Processing file...';
      document.getElementById('placedLoaderStatus').style.display = 'block';

      try {
          if (f.name.endsWith('.pdf')) {
              placedData = await readPdfFile(f);
          } else { // Assume Excel
              const data = await f.arrayBuffer();
              const wb = XLSX.read(data, {type:'array'});
              // Assume first sheet contains the data
              const sheet = wb.Sheets[wb.SheetNames[0]]; 
              placedData = XLSX.utils.sheet_to_json(sheet);
          }
          
          document.getElementById('placedLoaderStatus').style.display = 'none';
          showStatus('placedResults', `‚úÖ Placed candidates loaded: ${placedData.length} records from ${f.name}.`, 'success');
          renderPlacedResults([]); // Clear previous search results
      } catch (error) {
          console.error("File loading error:", error);
          document.getElementById('placedLoaderStatus').style.display = 'none';
          showStatus('placedResults', `‚ùå Error loading file: ${error.message}. Check file format.`, 'error');
      }
    });

    // Load Enrollment Excel
    document.getElementById('enrollFile').addEventListener('change', async (e)=>{
      const f = e.target.files[0]; if(!f) return;
      try {
        const data = await f.arrayBuffer();
        const wb = XLSX.read(data,{type:'array'});
        const sheet = wb.Sheets[wb.SheetNames[0]];
        const loaded = XLSX.utils.sheet_to_json(sheet);
        
        let added = 0;
        loaded.forEach(rec=>{
          const idx = String(rec['INDEX NUMBER']||'').trim();
          if(!idx) return;
          const dup = enrollmentData.find(x=>String(x['INDEX NUMBER']||'').trim()===idx);
          if(!dup){ enrollmentData.push(rec); added++; }
        });

        localStorage.setItem('enrollmentData', JSON.stringify(enrollmentData));
        renderEnrollmentList();
        showStatus('enrollStatus', `üì• Enrollment sheet loaded. Added ${added} new records (skipped duplicates). Total: ${enrollmentData.length}`, 'success');
      } catch (error) {
        showStatus('enrollStatus', `‚ùå Error loading enrollment file: ${error.message}.`, 'error');
      }
    });

    // Search Placed
    document.getElementById('placedSearchBtn').addEventListener('click', ()=>{
      const q = document.getElementById('placedQuery').value.trim().toLowerCase();
      if(placedData.length === 0) { showStatus('placedResults', '‚ö†Ô∏è Please load the Placed Candidates Data (.xlsx or .pdf) first.', 'error'); return; }
      if(!q){ showStatus('placedResults', '‚ö†Ô∏è Enter an Index Number or Name to search.', 'error'); return; }
      
      const results = placedData.filter(r => (String(r['INDEX NUMBER']||'').toLowerCase().includes(q) || String(r['NAME']||'').toLowerCase().includes(q)) );
      renderPlacedResults(results);
    });

    // Enrollment Form Validation & Add
    document.getElementById('addEnrollBtn').addEventListener('click', ()=>{
      if(!currentUser || (currentUser.role!=='Admin' && currentUser.role!=='Staff')){ 
        showStatus('enrollStatus', 'üõë Permission denied. Sign in as Admin or Staff to enroll.', 'error'); return; 
      }

      const index = document.getElementById('e_index').value.trim();
      const name = document.getElementById('e_name').value.trim();
      const phone = document.getElementById('e_phone').value.trim();

      if(!index || !name){ 
        showStatus('enrollStatus', '‚ö†Ô∏è Index Number and Full Name are required fields.', 'error'); return; 
      }
      if(phone && (phone.replace(/\D/g,'').length < 8 || phone.replace(/\D/g,'').length > 15)){ 
        showStatus('enrollStatus', '‚ö†Ô∏è Phone number must be 8-15 digits (or leave empty).', 'error'); return; 
      }
      if(enrollmentData.some(e => String(e['INDEX NUMBER']||'').trim()===index)){
        if(!confirm('A student with this Index Number is already enrolled. Add anyway?')){ return; }
      }

      const entry = {
        'INDEX NUMBER': index,
        'NAME': name,
        'GENDER': document.getElementById('e_gender').value,
        'PHONE NUMBER': phone,
        'RESIDENCE TYPE': document.getElementById('e_res').value,
        'PROGRAM': document.getElementById('e_prog').value.trim(),
        'CLASS': document.getElementById('e_class').value.trim(),
        'DATE ENROLLED': document.getElementById('e_date').value || new Date().toISOString().slice(0,10),
        'ENROLLED BY': currentUser.username, // Audit trail
        'ENROLLMENT TIMESTAMP': new Date().toISOString()
      };

      enrollmentData.push(entry);
      localStorage.setItem('enrollmentData', JSON.stringify(enrollmentData));
      renderEnrollmentList();
      
      // Clear form except gender/residence/date for fast entry
      document.getElementById('e_index').value=''; document.getElementById('e_name').value=''; document.getElementById('e_phone').value='';
      document.getElementById('e_prog').value=''; document.getElementById('e_class').value='';
      document.getElementById('e_index').focus();

      showStatus('enrollStatus', `‚úÖ Student ${entry['NAME']} added to local enrollment (offline-safe).`, 'success');
    });

    // Export Enrollment
    document.getElementById('exportEnrollBtn').addEventListener('click', ()=>{
      if(!currentUser || (currentUser.role!=='Admin' && currentUser.role!=='Staff')){ showStatus('enrollStatus', 'üõë Permission denied. Sign in as Admin or Staff to export.', 'error'); return; }
      if(enrollmentData.length===0){ showStatus('enrollStatus', '‚ö†Ô∏è No enrollment records to export.', 'error'); return; }
      
      const ws = XLSX.utils.json_to_sheet(enrollmentData);
      const wb = XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb, ws, 'Enrollment_Data');
      XLSX.writeFile(wb, `AL_KHULAFAU_Enrollment_${new Date().toISOString().slice(0,10)}.xlsx`);
      showStatus('enrollStatus', '‚¨áÔ∏è Enrollment data successfully exported to Excel.', 'success');
    });

    // Clear Enrollment
    document.getElementById('clearEnrollBtn').addEventListener('click', ()=>{
      if(!currentUser || currentUser.role!=='Admin'){ alert('Only Admin can clear local enrollment.'); return; }
      if(!confirm('DANGER ZONE: Clear ALL local enrollment data? This action is permanent locally.')) return;
      enrollmentData = []; 
      localStorage.removeItem('enrollmentData'); 
      renderEnrollmentList();
      showStatus('enrollStatus', 'üóëÔ∏è All local enrollment data has been cleared by Admin.', 'error');
    });

    // Template Downloads
    document.getElementById('downloadPlacedTemplate').addEventListener('click', ()=>{
      const sample = [{ 'INDEX NUMBER':'0801061023','NAME':'JOHN DOE','GENDER':'Male','PHONE NUMBER':'0240000000','RESIDENCE TYPE':'Day', 'PROGRAM':'Gen. Science' }];
      const ws = XLSX.utils.json_to_sheet(sample); const wb = XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb,ws,'Placed_Candidates'); XLSX.writeFile(wb,'placed_template.xlsx');
    });
    document.getElementById('downloadEnrollTemplate').addEventListener('click', ()=>{
      const sample = [{ 'INDEX NUMBER':'ENR0001','NAME':'JANE DOE','GENDER':'Female','PHONE NUMBER':'0240000000','RESIDENCE TYPE':'Day','PROGRAM':'Gen. Arts','CLASS':'Form 1 A','DATE ENROLLED':'2025-10-18', 'ENROLLED BY':'staff' }];
      const ws = XLSX.utils.json_to_sheet(sample); const wb = XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb,ws,'Enrollment_Data'); XLSX.writeFile(wb,'enrollment_template.xlsx');
    });

    // Tab Switching
    document.querySelectorAll('.tab').forEach(t=>t.addEventListener('click', ()=>{
      document.querySelectorAll('.tab').forEach(x=>x.classList.remove('active'));
      t.classList.add('active');
      document.querySelectorAll('.tab-content').forEach(c=>c.style.display='none');
      document.getElementById(t.dataset.tab).style.display='block';
      // Re-render list when moving to Enrollment tab
      if (t.dataset.tab === 'enroll') renderEnrollmentList();
    }));

    // --- Sign-in/out Flow ---
    document.getElementById('signBtn').addEventListener('click', ()=>{
      if(currentUser){ 
        if(confirm('Are you sure you want to sign out?')){ 
          currentUser=null; 
          localStorage.removeItem('ak_current_user'); 
          updateUserUI(); 
          document.getElementById('search').style.display = 'block'; // Default to search tab after logout
          document.querySelector('.tab[data-tab="search"]').click();
        } 
        return; 
      }
      document.getElementById('signinModal').style.display='flex';
      document.getElementById('signin_user').value=''; document.getElementById('signin_pass').value='';
      document.getElementById('signin_user').focus();
    });
    document.getElementById('signinCancel').addEventListener('click', ()=>{ document.getElementById('signinModal').style.display='none'; });
    document.getElementById('signinSubmit').addEventListener('click', ()=>{
      const u=document.getElementById('signin_user').value.trim(); const p=document.getElementById('signin_pass').value;
      if(!u || !p){ alert('Enter username and password'); return; }
      const found = users.find(x=>x.username===u && x.password===p);
      if(!found){ alert('Invalid credentials. Check username/password.'); return; }
      currentUser = { username: found.username, role: found.role };
      localStorage.setItem('ak_current_user', JSON.stringify(currentUser));
      document.getElementById('signinModal').style.display='none';
      updateUserUI();
      alert(`Signed in successfully as ${currentUser.username} (${currentUser.role}).`);
    });

    // --- PWA Installation & Service Worker ---
    let deferredPrompt;
    window.addEventListener('beforeinstallprompt', (e)=>{
      e.preventDefault(); deferredPrompt = e;
      document.getElementById('installBtn').style.display='inline-block';
    });
    document.getElementById('installBtn').addEventListener('click', async ()=>{
      if(!deferredPrompt) return;
      deferredPrompt.prompt();
      const choice = await deferredPrompt.userChoice;
      deferredPrompt = null;
      document.getElementById('installBtn').style.display='none';
    });
    
    // Manifest Setup (kept for PWA capability)
    const manifest = { name: 'AL KHULAFAU Student Portal', short_name: 'AK Portal', start_url: '.', display: 'standalone', background_color:'#ffffff', theme_color:'#4a90e2', icons: [{src:'data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="192" height="192"><rect width="100%" height="100%" fill="%234a90e2"/><text x="50%" y="55%" font-size="80" font-weight="bold" text-anchor="middle" fill="white">AK</text></svg>', sizes:'192x192', type:'image/svg+xml'}] };
    const manifestBlob = new Blob([JSON.stringify(manifest)], {type:'application/json'});
    const manifestURL = URL.createObjectURL(manifestBlob);
    const link = document.createElement('link'); link.rel='manifest'; link.href = manifestURL; document.head.appendChild(link);

    // Service worker starter download
    const swStarter = `// Simple service worker starter for offline caching
const CACHE_NAME = 'ak-student-cache-v1';
const ASSETS = [ '/', './', 'index.html' ]; // Add index.html for clarity
self.addEventListener('install', event => { self.skipWaiting(); event.waitUntil(caches.open(CACHE_NAME).then(cache => cache.addAll(ASSETS.map(asset => new Request(asset, {cache: "no-cache"})))).catch(err => console.error('Cache pre-fetch failed:', err))); });
self.addEventListener('activate', event => { event.waitUntil(self.clients.claim()); });
self.addEventListener('fetch', event => { if (event.request.method !== 'GET' || !event.request.url.startsWith('http')) return; event.respondWith(caches.match(event.request).then(r => r || fetch(event.request).then(f => { caches.open(CACHE_NAME).then(c => c.put(event.request, f.clone())); return f; })).catch(() => caches.match('/'))); });`;

    document.getElementById('downloadSwBtn').addEventListener('click', ()=>{
      const blob = new Blob([swStarter], {type: 'text/javascript'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a'); a.href = url; a.download = 'sw.js'; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
      alert('sw.js downloaded. Host it on the same origin as the app and register via navigator.serviceWorker.register(`/sw.js`)');
    });

    // --- Initialization ---
    renderEnrollmentList(); 
    updateUserUI(); 
    document.getElementById('e_date').value = new Date().toISOString().slice(0,10); // Set default date
    console.log('AL KHULAFAU Student Portal ready.');
  </script>
</body>
</html>
