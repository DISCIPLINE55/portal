<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>AL KHULAFAU 2025 ‚Äî School Management (Dashboard)</title>

  <!-- Libraries -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

  <style>
    :root{--bg1:#74ABE2;--bg2:#5563DE;--card:#ffffff}
    *{box-sizing:border-box}
    body{font-family:Inter,system-ui,Segoe UI,Roboto,Arial; margin:0; min-height:100vh; background:linear-gradient(135deg,var(--bg1),var(--bg2)); display:flex; align-items:center; justify-content:center; padding:20px}
    .app{width:100%;max-width:1200px;background:var(--card);border-radius:14px;padding:18px;box-shadow:0 12px 40px rgba(12,20,40,0.18)}
    .header{display:flex;align-items:center;justify-content:space-between;gap:12px}
    h1{margin:0;font-size:20px}
    .tabs{display:flex;gap:8px;margin-top:12px;flex-wrap:wrap}
    .tab{padding:8px 12px;border-radius:10px;border:1px solid #e6e9ef;background:#f7f8fb;cursor:pointer}
    .tab.active{background:linear-gradient(90deg,var(--bg2),#3b49b7);color:#fff;border:none}
    .content{margin-top:14px}
    .row{display:flex;gap:12px;flex-wrap:wrap}
    .col{flex:1;min-width:240px}
    input,select,textarea{width:100%;padding:10px;border-radius:8px;border:1px solid #e3e6ee}
    label{display:block;margin-bottom:6px;font-size:13px}
    .btn{display:inline-block;padding:10px 14px;border-radius:10px;border:none;background:var(--bg2);color:#fff;cursor:pointer}
    .btn.secondary{background:#2ecc71}
    .panel{margin-top:12px;padding:14px;border-radius:10px;background:#f8f9fc;border:1px solid #eef2ff}
    table{width:100%;border-collapse:collapse;margin-top:8px}
    th,td{padding:8px;border-bottom:1px solid #eee;text-align:left;font-size:13px}
    .small{font-size:12px;color:#666}
    .card{padding:12px;border-radius:8px;background:#fff;border:1px solid #eef2ff}
    .stat-grid{display:flex;gap:12px;flex-wrap:wrap;margin-top:8px}
    .stat{flex:1;min-width:160px;padding:10px;border-radius:8px;background:#fff;border:1px solid #eef2ff}
    .warning{background:#fff3cd;color:#856404;padding:8px;border-radius:6px;margin-top:10px}
    .muted{color:#666;font-size:13px}
    .actions button{margin-right:6px}
    @media(max-width:880px){ .row{flex-direction:column} .stat-grid{flex-direction:column} }
  </style>
</head>
<body>
  <div class="app" role="application">
    <div class="header">
      <div>
        <h1>AL KHULAFAU 2025 ‚Äî School Management</h1>
        <div class="muted">Persistent local Excel uploads ¬∑ Dashboard ¬∑ Export ¬∑ Offline-safe</div>
      </div>
      <div style="display:flex;gap:8px;align-items:center">
        <div id="installWrapper" style="display:flex;align-items:center;gap:8px">
          <button class="btn" id="installBtn" style="display:none">Install App</button>
        </div>
        <button class="btn secondary" id="downloadSwBtn">Download sw.js</button>
      </div>
    </div>

    <div class="tabs" role="tablist">
      <div class="tab active" data-tab="dashboard">üìä Dashboard</div>
      <div class="tab" data-tab="search">üîç Search</div>
      <div class="tab" data-tab="enroll">üìù Enroll</div>
      <div class="tab" data-tab="manage">‚öôÔ∏è Manage</div>
    </div>

    <div class="content">

      <!-- DASHBOARD -->
      <div id="dashboard" class="tab-content">
        <div class="panel">
          <h3 style="margin:0 0 8px 0">Dashboard</h3>

          <div class="stat-grid">
            <div class="stat">
              <div class="muted">Total Placed Students</div>
              <div id="statPlaced" style="font-size:20px;font-weight:700">0</div>
            </div>
            <div class="stat">
              <div class="muted">Total Enrolled Students</div>
              <div id="statEnrolled" style="font-size:20px;font-weight:700">0</div>
            </div>
            <div class="stat">
              <div class="muted">Last Placed Upload</div>
              <div id="metaPlaced" class="muted">‚Äî</div>
            </div>
            <div class="stat">
              <div class="muted">Last Enrollment Upload/Change</div>
              <div id="metaEnroll" class="muted">‚Äî</div>
            </div>
          </div>

          <div style="display:flex;gap:12px;margin-top:12px;flex-wrap:wrap">
            <div style="flex:1;min-width:300px" class="card">
              <canvas id="barChart" height="180"></canvas>
            </div>
            <div style="flex:1;min-width:260px" class="card">
              <canvas id="pieChart" height="180"></canvas>
            </div>
          </div>

        </div>
      </div>

      <!-- SEARCH -->
      <div id="search" class="tab-content" style="display:none">
        <div class="panel">
          <div class="row">
            <div class="col">
              <label>Load Placed or Enrollment Excel (will persist)</label>
              <input type="file" id="uploadAnyFile" accept=".xlsx" />
            </div>
            <div class="col">
              <label>Search by Index or Name</label>
              <input type="text" id="searchQuery" placeholder="e.g. 0801061023 or 'ABDUL'" />
            </div>
            <div style="display:flex;align-items:flex-end;gap:8px">
              <button class="btn" id="doSearchBtn">Search</button>
            </div>
          </div>

          <div id="searchResults" style="margin-top:12px"></div>
        </div>
      </div>

      <!-- ENROLL -->
      <div id="enroll" class="tab-content" style="display:none">
        <div class="panel">
          <h3 style="margin:0 0 8px 0">Enroll Student (adds to current Enrollment dataset)</h3>
          <div class="row">
            <div class="col"><label>Index Number</label><input type="text" id="e_index"></div>
            <div class="col"><label>Name</label><input type="text" id="e_name"></div>
            <div class="col"><label>Gender</label><select id="e_gender"><option>Male</option><option>Female</option><option>Other</option></select></div>
          </div>
          <div class="row" style="margin-top:8px">
            <div class="col"><label>Program</label><input id="e_prog"></div>
            <div class="col"><label>Class</label><input id="e_class"></div>
            <div class="col"><label>Phone</label><input id="e_phone"></div>
          </div>
          <div style="margin-top:10px;display:flex;gap:8px">
            <button class="btn" id="addEnrollmentBtn">Add & Save</button>
            <button class="btn secondary" id="exportEnrollmentBtn">Export Enrollment</button>
          </div>

          <div id="enrollListBox" style="margin-top:12px"></div>
        </div>
      </div>

      <!-- MANAGE -->
      <div id="manage" class="tab-content" style="display:none">
        <div class="panel">
          <h3 style="margin:0 0 8px 0">Manage Data & Templates</h3>
          <div class="row">
            <div class="col">
              <label>Upload Placed Excel (persists & merges)</label>
              <input type="file" id="uploadPlacedFile" accept=".xlsx" />
            </div>
            <div class="col">
              <label>Upload Enrollment Excel (persists & merges)</label>
              <input type="file" id="uploadEnrollmentFile" accept=".xlsx" />
            </div>
          </div>

          <div style="margin-top:12px" class="row">
            <div class="col">
              <label>Drop Data</label>
              <div style="display:flex;gap:8px">
                <button class="btn" id="dropPlacedBtn">Drop Placed Data</button>
                <button class="btn" id="dropEnrollBtn">Drop Enrollment Data</button>
                <button class="btn secondary" id="dropAllBtn">Drop All</button>
              </div>
            </div>
            <div class="col">
              <label>Exports</label>
              <div style="display:flex;gap:8px">
                <button class="btn" id="exportPlacedBtn">Export Placed</button>
                <button class="btn" id="exportEnrollBtn">Export Enrollment</button>
              </div>
            </div>
          </div>

          <div style="margin-top:12px" class="row">
            <div class="col">
              <label>Storage</label>
              <div id="storageInfo" class="card muted">‚Äî</div>
            </div>
            <div class="col">
              <label>Templates</label>
              <div style="display:flex;gap:8px">
                <button class="btn" id="downloadTemplateBtn">Download Template</button>
              </div>
            </div>
          </div>
        </div>
      </div>

    </div>
  </div>

  <script>
    /* ---------------------------
       Keys & metadata helpers
       --------------------------- */
    const KEY_PLACED = 'ak_placed_data';
    const KEY_PLACED_META = 'ak_placed_meta';
    const KEY_ENROLL = 'ak_enroll_data';
    const KEY_ENROLL_META = 'ak_enroll_meta';

    // default audit identity for now
    const DEFAULT_EDITOR = 'System Admin';

    function nowISO(){ return new Date().toISOString(); }
    function savePlaced(data){
      localStorage.setItem(KEY_PLACED, JSON.stringify(data));
      localStorage.setItem(KEY_PLACED_META, JSON.stringify({ lastUpload: nowISO(), count: data.length }));
    }
    function saveEnroll(data){
      localStorage.setItem(KEY_ENROLL, JSON.stringify(data));
      localStorage.setItem(KEY_ENROLL_META, JSON.stringify({ lastUpload: nowISO(), count: data.length }));
    }
    function loadPlaced(){ return JSON.parse(localStorage.getItem(KEY_PLACED) || '[]'); }
    function loadEnroll(){ return JSON.parse(localStorage.getItem(KEY_ENROLL) || '[]'); }
    function loadPlacedMeta(){ return JSON.parse(localStorage.getItem(KEY_PLACED_META) || 'null'); }
    function loadEnrollMeta(){ return JSON.parse(localStorage.getItem(KEY_ENROLL_META) || 'null'); }

    // global in-memory view
    let placed = loadPlaced();
    let enrolled = loadEnroll();

    /* ---------------------------
       UI references
       --------------------------- */
    const statPlacedEl = document.getElementById('statPlaced');
    const statEnrolledEl = document.getElementById('statEnrolled');
    const metaPlacedEl = document.getElementById('metaPlaced');
    const metaEnrollEl = document.getElementById('metaEnroll');
    const storageInfoEl = document.getElementById('storageInfo');

    const searchResultsEl = document.getElementById('searchResults');
    const enrollListBox = document.getElementById('enrollListBox');

    /* ---------------------------
       Charts
       --------------------------- */
    const barCtx = document.getElementById('barChart').getContext('2d');
    const pieCtx = document.getElementById('pieChart').getContext('2d');
    let barChart = new Chart(barCtx, {
      type: 'bar',
      data: { labels: ['Placed','Enrolled'], datasets: [{ label: 'Students', data: [0,0], backgroundColor: ['#5563DE','#2ecc71'] }] },
      options: { responsive: true, plugins:{legend:{display:false}} }
    });
    let pieChart = new Chart(pieCtx, {
      type: 'pie',
      data: { labels: ['Male','Female','Other'], datasets:[{ data:[0,0,0], backgroundColor:['#3b82f6','#fb7185','#f59e0b'] }] },
      options:{responsive:true}
    });

    /* ---------------------------
       Dashboard update
       --------------------------- */
    function updateDashboard(){
      const placedCount = (placed || []).length;
      const enrollCount = (enrolled || []).length;
      statPlacedEl.textContent = placedCount;
      statEnrolledEl.textContent = enrollCount;

      const pMeta = loadPlacedMeta();
      const eMeta = loadEnrollMeta();
      metaPlacedEl.textContent = pMeta ? `${new Date(pMeta.lastUpload).toLocaleString()} (${pMeta.count})` : '‚Äî';
      metaEnrollEl.textContent = eMeta ? `${new Date(eMeta.lastUpload).toLocaleString()} (${eMeta.count})` : '‚Äî';

      // update charts
      barChart.data.datasets[0].data = [placedCount, enrollCount];
      barChart.update();

      // gender pie across both sets (prefer enrollment first, then placed)
      const combined = [...placed, ...enrolled];
      const genders = { Male:0, Female:0, Other:0 };
      combined.forEach(r=>{
        const g = String(r['GENDER']||r['gender']||'').trim().toLowerCase();
        if(g.startsWith('m')) genders.Male++;
        else if(g.startsWith('f')) genders.Female++;
        else genders.Other++;
      });
      pieChart.data.datasets[0].data = [genders.Male,genders.Female,genders.Other];
      pieChart.update();

      // storage usage
      const used = (localStorageToSize()).toLocaleString();
      storageInfoEl.textContent = `${used} bytes used in localStorage`;
    }

    function localStorageToSize(){
      // rough bytes used by localStorage (sum of key+value lengths)
      let total = 0;
      for(let i=0;i<localStorage.length;i++){
        const k = localStorage.key(i);
        const v = localStorage.getItem(k);
        total += (k.length + v.length);
      }
      return total;
    }

    /* ---------------------------
       Render helpers
       --------------------------- */
    function renderSearchResults(list){
      if(!list || list.length===0){ searchResultsEl.innerHTML = '<div class="card">No results.</div>'; return; }
      let html = '<table><thead><tr><th>Index</th><th>Name</th><th>Gender</th><th>Program</th><th>Phone</th></tr></thead><tbody>';
      list.forEach(r=>{
        html += `<tr><td>${escapeHtml(r['INDEX NUMBER']||r['Index']||'')}</td><td>${escapeHtml(r['NAME']||r['Name']||'')}</td><td>${escapeHtml(r['GENDER']||r['Gender']||'')}</td><td>${escapeHtml(r['PROGRAM']||r['Program']||'')}</td><td>${escapeHtml(r['PHONE NUMBER']||r['Phone']||'')}</td></tr>`;
      });
      html += '</tbody></table>';
      searchResultsEl.innerHTML = html;
    }

    function escapeHtml(s){ return String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }

    function renderEnrollList(){
      if(!enrolled || enrolled.length===0){ enrollListBox.innerHTML = '<div class="card small">No enrolled students yet.</div>'; updateDashboard(); return; }
      let html = '<table><thead><tr><th>Index</th><th>Name</th><th>Program</th><th>Class</th><th>Last Edited</th><th>Actions</th></tr></thead><tbody>';
      enrolled.forEach((r,i)=>{
        html += `<tr>
          <td>${escapeHtml(r['INDEX NUMBER'])}</td>
          <td>${escapeHtml(r['NAME'])}</td>
          <td>${escapeHtml(r['PROGRAM']||'')}</td>
          <td>${escapeHtml(r['CLASS']||'')}</td>
          <td>${escapeHtml(r['lastEditedBy']||'') || escapeHtml(r['lastModified']||'')}</td>
          <td class="actions">
            <button class="btn" onclick="editEnroll(${i})">Edit</button>
            <button class="btn secondary" onclick="deleteEnroll(${i})">Delete</button>
          </td>
        </tr>`;
      });
      html += '</tbody></table>';
      enrollListBox.innerHTML = html;
      updateDashboard();
    }

    /* ---------------------------
       Upload + Merge + Dedup
       --------------------------- */
    function mergeInto(targetArray, incoming, key='INDEX NUMBER'){
      // returns number added
      let added = 0;
      const exists = new Set(targetArray.map(x=>String(x[key]||'').trim()));
      incoming.forEach(rec=>{
        const id = String(rec[key]||'').trim();
        if(!id) return;
        if(!exists.has(id)){
          // enrich audit fields
          rec.lastEditedBy = rec.lastEditedBy || DEFAULT_EDITOR;
          rec.lastModified = rec.lastModified || nowISO();
          targetArray.push(rec);
          exists.add(id);
          added++;
        }
      });
      return added;
    }

    async function handleExcelFile(file){
      const data = await file.arrayBuffer();
      const wb = XLSX.read(data, { type: 'array' });
      const sheet = wb.Sheets[wb.SheetNames[0]];
      return XLSX.utils.sheet_to_json(sheet);
    }

    /* ---------------------------
       Event wiring
       --------------------------- */

    // Dashboard is default, initial render
    updateDashboard();
    renderEnrollList();

    // Tabs
    document.querySelectorAll('.tab').forEach(t=>t.addEventListener('click',()=>{
      document.querySelectorAll('.tab').forEach(x=>x.classList.remove('active'));
      t.classList.add('active');
      document.querySelectorAll('.tab-content').forEach(c=>c.style.display='none');
      document.getElementById(t.dataset.tab).style.display='block';
      // trigger chart resize/update when dashboard shown
      if(t.dataset.tab === 'dashboard') { updateDashboard(); barChart.resize(); pieChart.resize(); }
    }));

    // Upload placed
    document.getElementById('uploadPlacedFile').addEventListener('change', async (e)=>{
      const f = e.target.files[0]; if(!f) return;
      const incoming = await handleExcelFile(f);
      const added = mergeInto(placed, incoming, 'INDEX NUMBER');
      savePlaced(placed);
      alert(`Placed: ${added} new record(s) merged.`);
      updateDashboard();
      e.target.value = '';
    });

    // Upload enrollment
    document.getElementById('uploadEnrollmentFile').addEventListener('change', async (e)=>{
      const f = e.target.files[0]; if(!f) return;
      const incoming = await handleExcelFile(f);
      // enrich fields to match keys
      incoming.forEach(r=>{
        if(!r['lastEditedBy']) r.lastEditedBy = DEFAULT_EDITOR;
        if(!r['lastModified']) r.lastModified = nowISO();
      });
      const added = mergeInto(enrolled, incoming, 'INDEX NUMBER');
      saveEnroll(enrolled);
      alert(`Enrollment: ${added} new record(s) merged.`);
      renderEnrollList();
      e.target.value = '';
    });

    // Generic upload for the search tab (persist)
    document.getElementById('uploadAnyFile').addEventListener('change', async (e)=>{
      const f = e.target.files[0]; if(!f) return;
      const incoming = await handleExcelFile(f);
      // ask user: treat as placed or enrollment
      const treat = confirm('Click OK to treat this as ENROLLMENT (merge into enrollment). Cancel to treat as PLACED.');
      if(treat){
        incoming.forEach(r=>{ r.lastEditedBy = r.lastEditedBy || DEFAULT_EDITOR; r.lastModified = r.lastModified || nowISO(); });
        const added = mergeInto(enrolled, incoming, 'INDEX NUMBER');
        saveEnroll(enrolled);
        alert(`Merged ${added} records into Enrollment.`);
        renderEnrollList();
      } else {
        const added = mergeInto(placed, incoming, 'INDEX NUMBER');
        savePlaced(placed);
        alert(`Merged ${added} records into Placed.`);
        updateDashboard();
      }
      e.target.value = '';
    });

    // Search
    document.getElementById('doSearchBtn').addEventListener('click', ()=>{
      const q = String(document.getElementById('searchQuery').value||'').trim().toLowerCase();
      if(!q) return alert('Enter query');
      // search both datasets
      const combined = [...placed, ...enrolled];
      const results = combined.filter(r => {
        const idx = String(r['INDEX NUMBER']||'').toLowerCase();
        const name = String(r['NAME']||'').toLowerCase();
        return idx.includes(q) || name.includes(q);
      });
      renderSearchResults(results);
    });

    // Add enrollment via form
    document.getElementById('addEnrollmentBtn').addEventListener('click', ()=>{
      const idx = String(document.getElementById('e_index').value||'').trim();
      const name = String(document.getElementById('e_name').value||'').trim();
      const gender = document.getElementById('e_gender').value || '';
      const program = document.getElementById('e_prog').value || '';
      const klass = document.getElementById('e_class').value || '';
      const phone = document.getElementById('e_phone').value || '';

      if(!idx || !name) return alert('Index and Name are required');

      // duplicate check across both datasets
      const dupPlaced = placed.some(p => String(p['INDEX NUMBER']||'').trim() === idx);
      const dupEnroll = enrolled.some(e => String(e['INDEX NUMBER']||'').trim() === idx);
      if(dupPlaced || dupEnroll){
        if(!confirm('A record with this Index exists (placed or enrolled). Click OK to still add, Cancel to stop.')) return;
      }

      const record = {
        'INDEX NUMBER': idx,
        'NAME': name,
        'GENDER': gender,
        'PROGRAM': program,
        'CLASS': klass,
        'PHONE NUMBER': phone,
        lastEditedBy: DEFAULT_EDITOR,
        lastModified: nowISO()
      };

      enrolled.push(record);
      saveEnroll(enrolled);
      renderEnrollList();

      // clear form
      document.getElementById('e_index').value=''; document.getElementById('e_name').value=''; document.getElementById('e_phone').value='';

      alert('Enrollment record saved locally.');
      updateDashboard();
    });

    // Export handlers
    function exportDataToExcel(arr, name){
      const ws = XLSX.utils.json_to_sheet(arr);
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, name);
      XLSX.writeFile(wb, `${name.replace(/\s+/g,'_')}.xlsx`);
    }

    document.getElementById('exportPlacedBtn').addEventListener('click', ()=> exportDataToExcel(placed || [], 'Placed'));
    document.getElementById('exportEnrollBtn').addEventListener('click', ()=> exportDataToExcel(enrolled || [], 'Enrollment'));
    document.getElementById('exportPlaced').addEventListener && document.getElementById('exportPlaced').addEventListener('click', ()=> exportDataToExcel(placed || [], 'Placed'));

    // enroll tab export
    document.getElementById('exportEnrollmentBtn').addEventListener('click', ()=> exportDataToExcel(enrolled || [], 'Enrollment'));

    // Manage: drop
    document.getElementById('dropPlacedBtn').addEventListener('click', ()=>{
      if(confirm('Drop Placed data from localStorage?')){ localStorage.removeItem(KEY_PLACED); localStorage.removeItem(KEY_PLACED_META); placed = []; updateDashboard(); alert('Placed data dropped.'); }
    });
    document.getElementById('dropEnrollBtn').addEventListener('click', ()=>{
      if(confirm('Drop Enrollment data from localStorage?')){ localStorage.removeItem(KEY_ENROLL); localStorage.removeItem(KEY_ENROLL_META); enrolled = []; renderEnrollList(); updateDashboard(); alert('Enrollment data dropped.'); }
    });
    document.getElementById('dropAllBtn').addEventListener('click', ()=>{
      if(confirm('Drop ALL stored data (Placed + Enrollment)?')){
        localStorage.removeItem(KEY_PLACED); localStorage.removeItem(KEY_PLACED_META);
        localStorage.removeItem(KEY_ENROLL); localStorage.removeItem(KEY_ENROLL_META);
        placed = []; enrolled = []; renderEnrollList(); updateDashboard(); alert('All data dropped.');
      }
    });

    // Download template
    document.getElementById('downloadTemplateBtn').addEventListener('click', ()=>{
      const sample = [{'INDEX NUMBER':'001','NAME':'John Doe','GENDER':'Male','PROGRAM':'Science','CLASS':'Form 1','PHONE NUMBER':'0240000000'}];
      exportDataToExcel(sample, 'template');
    });

    // storage info initial
    storageInfoEl.textContent = `${localStorageToSize().toLocaleString()} bytes used in localStorage`;

    /* ---------------------------
       Edit & Delete helpers (enrollment)
       --------------------------- */
    window.editEnroll = function(i){
      const r = enrolled[i];
      if(!r) return;
      document.getElementById('e_index').value = r['INDEX NUMBER'] || '';
      document.getElementById('e_name').value = r['NAME'] || '';
      document.getElementById('e_gender').value = r['GENDER'] || 'Male';
      document.getElementById('e_prog').value = r['PROGRAM'] || '';
      document.getElementById('e_class').value = r['CLASS'] || '';
      document.getElementById('e_phone').value = r['PHONE NUMBER'] || '';
      // remove the record so that saving will re-add it (update)
      enrolled.splice(i,1);
      saveEnroll(enrolled);
      renderEnrollList();
      updateDashboard();
    };

    window.deleteEnroll = function(i){
      if(!confirm('Delete this enrolled student?')) return;
      enrolled.splice(i,1);
      saveEnroll(enrolled);
      renderEnrollList();
      updateDashboard();
    };

    /* ---------------------------
       sw.js download (starter) - no blob registration
       --------------------------- */
    const swStarter = `// sw.js starter - host this file on the same origin as your app to enable service worker caching
const CACHE_NAME = 'ak-school-cache-v1';
const ASSETS = ['/', './'];
self.addEventListener('install', (event) => {
  self.skipWaiting();
  event.waitUntil(caches.open(CACHE_NAME).then((cache) => cache.addAll(ASSETS)));
});
self.addEventListener('activate', (event) => {
  event.waitUntil(self.clients.claim());
});
self.addEventListener('fetch', (event) => {
  if (event.request.method !== 'GET') return;
  event.respondWith(caches.match(event.request).then((r) => r || fetch(event.request).then((f) => { if (event.request.url.startsWith('http')) caches.open(CACHE_NAME).then(c => c.put(event.request, f.clone())); return f; })));
});`;

    document.getElementById('downloadSwBtn').addEventListener('click', ()=>{
      const blob = new Blob([swStarter], { type: 'text/javascript' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a'); a.href = url; a.download = 'sw.js'; document.body.appendChild(a); a.click(); a.remove();
      URL.revokeObjectURL(url);
      alert('Downloaded sw.js starter. Host it at /sw.js on your server and register with navigator.serviceWorker.register(\"/sw.js\")');
    });

    /* ---------------------------
       PWA install prompt handling
       --------------------------- */
    let deferredPrompt;
    window.addEventListener('beforeinstallprompt', (e)=>{
      e.preventDefault();
      deferredPrompt = e;
      document.getElementById('installBtn').style.display = 'inline-block';
    });
    document.getElementById('installBtn').addEventListener('click', async ()=>{
      if(!deferredPrompt) return;
      deferredPrompt.prompt();
      await deferredPrompt.userChoice;
      deferredPrompt = null;
      document.getElementById('installBtn').style.display = 'none';
    });

    /* ---------------------------
       Auto-save on unload and update indicators
       --------------------------- */
    window.addEventListener('beforeunload', ()=>{
      // ensure meta saved
      savePlaced(placed);
      saveEnroll(enrolled);
    });

    // Keep dashboard live when enrollment changes - we call updateDashboard() or renderEnrollList() where appropriate
    // Initial update to reflect loaded persisted data:
    updateDashboard();
    renderEnrollList();

  </script>
</body>
</html>
